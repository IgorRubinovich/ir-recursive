<dom-module id="ir-recursive">  
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <content id="templates"></content>
    <iron-ajax
    	id="getDataLoader"
    	method="GET"
    	handle-as="json"
    	url="/category/json/?limit=100"
    	last-response="{{ reqData }}"
    	on-response="transformData"
    	debounce-duration="300"
    ></iron-ajax>
    <iron-ajax
		id="deleteLoader"
		method="DELETE"
		content-type = "application/x-www-form-urlencoded"
		handle-as="json"
		on-response="setAvailable"
		debounce-duration="300"
		verbose=true
	></iron-ajax>
  </template>
</dom-module>
<script>
  (function () {
    Polymer({
		is: 'ir-recursive',
		properties: {
			data: {
				type: Object,
				notify: true
			},
			reqData : {
				type: Object,
				value : {}
			},	
			tree : {
				type: Object,
				value : {},
				observer : "treeReady"
			},		
			itemTemplate: {
				type: Object,
				notify: true
			},
			initSelector: {
				type: String,
				notify: true
			},
			onInit: {
				type: String,
				notify: true
			},
			maxDepth: {
				type: Number,
				notify: true
			},
			isAvail: {
				type: Boolean,
				value: true
			},
			itemsToDelete: {
				type: Array,
				value: []
			}
		},
		  
		behaviors: [
			Polymer.Templatizer
		],
		
		expand : function(ev) {
			ev.target._height = 0;
			ev.target.style.height = ev.target._height;
		},
		collapse : function(ev) {
			ev._height = 0;
			ev.style.height = 0;
		},

		treeReady : function() {
			if(!this.isTreeEmpty())
				this.drawTemplates();
		},

		isTreeEmpty : function() {
			for(var field in this.tree) 
				return false;

			return true;
		},

		transformData : function() {

		},

		handleItem : function() {

		},

		setAvailable : function() {
			if(this.itemsToDelete.length > 0)
				this.deleteItem(this.itemsToDelete.shift());
			else
				this.isAvail = true;
		},

		deleteItem : function(itemUrl) {
			this.$.deleteLoader.url = itemUrl;
			this.$.deleteLoader.generateRequest();
		},
		
		ready: function() {

			this.addEventListener('delete-ev', function(ev) {
				if(this.isAvail)
				{
					this.isAvail = false;
					this.deleteItem(ev.detail);
				}
				else
					this.itemsToDelete.push(ev.detail);		
			}.bind(this));

			var templates = Polymer.dom(this.$.templates).getDistributedNodes(),
				scriptTemplate;
			templates.forEach(function(el) {
				if(el.hasAttribute('script-t'))
					scriptTemplate = el;
			});
			//this.templatize(template);
			//this.itemTemplate = template;

			if(scriptTemplate)
			{
				this.templatize(scriptTemplate);

				var clone = this.stamp(this.commands);

				Polymer.dom(this.root).appendChild(clone.root);

				this.fire('script-ready');

				this.$.getDataLoader.generateRequest();
			}
				
			
			this.data = {
				title : "Some title A",
				content : "Some content",
				children : [
					{
						title : "Some child title A1",
						content : "Some child content",
						children : [
							{
								title : "Some child title A1.1",
								content : "Some child content"
							},
							{
								title : "Some child title A1.2",
								content : "Some child content",
								children : [
									{
										title : "Some child title A2.21",
										content : "Some child content"
									},
									{
										title : "Some child title A2.22",
										content : "Some child content"
									}						
								]
							}						
						]
					},
					{
						title : "Some child title A2",
						content : "Some child content",
						children : [
							{
								title : "Some child title A2.1",
								content : "Some child content"
							},
							{
								title : "Some child title A2.2",
								content : "Some child content"
							}						
						]
					}
				]				
			}

		},

		drawTemplates : function() {
			var ri, templates = Polymer.dom(this.$.templates).getDistributedNodes(),
				template, editTemplate, createTemplate, deleteTemplate, scriptTemplate;
			templates.forEach(function(el) {
				if(el.hasAttribute('item'))
					template = el;
				if(el.hasAttribute('edit'))
					editTemplate = el;
				if(el.hasAttribute('create'))
					createTemplate = el;
				if(el.hasAttribute('delete'))
					deleteTemplate = el;
				if(el.hasAttribute('script-t'))
					scriptTemplate = el;
			});

			this.itemTemplate = template;			

			ri = document.createElement('ir-recursive-item');
			ri.itemTemplate = template;
			ri.editTemplate = editTemplate;
			ri.createTemplate = createTemplate;
			ri.deleteTemplate = deleteTemplate;
			ri.data = this.tree;	
			ri.initSelector = this.initSelector;
			ri.onInit  = this.onInit;
			ri.maxDepth = this.maxDepth;
			ri.depth = 0;
			
			Polymer.dom(this.root).appendChild(ri);
		}
    });
	
	var behavior = {
	}
  })();
</script> 

<dom-module id="ir-recursive-item">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
  	<iron-ajax
		id="getItemLoader"
		content-type="application/json"
		method="GET"
		handle-as="json"
		on-response="editItem"
		debounce-duration="300"
		verbose=true
	></iron-ajax>
	<iron-ajax
		id="addLoader"
		method="POST"
		content-type="application/json"
		handle-as="json"
		debounce-duration="300"
		verbose=true
	></iron-ajax>
  </template>
</dom-module>

<script>
	(function () {
		Polymer({
			is: 'ir-recursive-item',
			properties: {
				data: {
					type: Object,
					notify: true,
				},
				lastItem: {
					type: Object,
					value: {}
				},
				itemTemplate: {
					type : Object,
					notify: true
				},
				editTemplate: {
					type : Object,
					notify: true
				},
				createTemplate: {
					type : Object,
					notify: true
				},
				initSelector: {
					type: String,
					notify: true
				},
				onInit: {
					type: String,
					notify: true
				},
				maxDepth: {
					type: Number,
					notify: true
				},
				depth: {
					type: Number,
					notify: true,
					value: 0
				}
			},
			behaviors: [
				Polymer.Templatizer
			],

			expand : function(ev) {
				this.collapsed = false;
				this.updateStyles();

				for(i = 0; i <= 400; i += 100)
					setTimeout(function() {
						this.fire('update-styles');
					}.bind(this), i);
			},
			
			collapse : function(ev) {
				this.collapsed = true;
				this.childrenContainer.style.transition = "all 300ms"
				this.childrenContainer._height = this.childrenContainer.getBoundingClientRect().height || this.childrenContainer._height;
				this.updateStyles();
				for(i = 0; i <= 400; i += 100)
					setTimeout(function() {
						this.fire('update-styles');
					}.bind(this), i);
			},

			edit : function(ev) {
				contentEl = Polymer.dom(this.root).querySelector('[content]');

				if(this.editTemplate)
				{
					this.templatize(this.editTemplate);

					var clone = this.stamp(this.commands);

					contentEl.innerHTML = "";
					Polymer.dom(contentEl).appendChild(clone.root);

					var iframe = document.createElement('shadow-iframe');
						iframe.urlParams ='{ "noCache" : "true" }';
						iframe.hijackForm = true;
						iframe.url = "/category/partial/" + this.data.id + "/edit";
						var that = this;
						iframe.formSubmitted = function(ev) {
							this.isSubmitInProgress = false;
							this.httpMethod = null;

							var item;

							that.$.getItemLoader.url = "/category/json/" + that.data.id + "/?noCache=true";
							that.$.getItemLoader.generateRequest();
							
								
							this.setDisplayMode('ready');

							this._form = null;
						};

					Polymer.dom(contentEl).appendChild(iframe);

					contentEl.querySelector('[close-button]').addEventListener('click', function() {
						
						contentEl.parentNode.removeChild(contentEl);
						this.initializeTemplate(false);

					}.bind(this));

					contentEl.querySelector('[save-button]').addEventListener('click', function(ev) {
						this.data.title = this.querySelector('[edit-input]').value;

						contentEl.parentNode.removeChild(contentEl);
						this.initializeTemplate(false);
					}.bind(this));

				}
				
			},

			editItem : function() {
				var contentEl = Polymer.dom(this.root).querySelector('[content]');

				var item = this.$.getItemLoader.lastResponse;

				this.data.id = item.id;
				this.data.title = item.title;
				this.data.content = item.content;

				contentEl.parentNode.removeChild(contentEl);
				this.initializeTemplate(false);
			},

			create : function(ev) {
				contentEl = Polymer.dom(this.root).querySelector('[content]');
				
				if(this.createTemplate)
				{
					this.templatize(this.createTemplate);

					var clone = this.stamp(this.commands);

					contentEl.innerHTML = "";
					Polymer.dom(contentEl).appendChild(clone.root);
					
					var iframe = document.createElement('shadow-iframe');
						iframe.urlParams ='{ "noCache" : "true" }';
						iframe.hijackForm = true;
						iframe.url = "/category/partial/create";
						iframe.submitUrl = "/category/json";
						var that = this;
						iframe.formSubmitted = function(ev) {
							this.isSubmitInProgress = false;
							this.httpMethod = null;
							that.createItem(this.lastFormResponse);
							this.setDisplayMode('ready');

							this._form = null;
						};
					
					Polymer.dom(contentEl).appendChild(iframe);

					contentEl.querySelector('[close-button]').addEventListener('click', function() {
						contentEl.parentNode.removeChild(contentEl);
						this.initializeTemplate(false);
					}.bind(this));
				}
			},

			createItem : function(item) {
				var newData = {};
				var contentEl = Polymer.dom(this.root).querySelector('[content]');

				item = JSON.parse(item);

				if(this.data.id != 0)
				{
					this.$.addLoader.url = "/category/json/" + this.data.id + "/add/";
					this.$.addLoader.body = JSON.stringify({ 'id' : item.id });
					this.$.addLoader.generateRequest();
				}
				

				newData['id'] = item.id;
				newData['title'] = item.title;
				newData['content'] = item.content; 

				if(!this.data['children'])
					this.data['children'] = [];

				this.data['children'].push(newData);

				var child = document.createElement('ir-recursive-item');
					child.data = this.data.children[this.data.children.length - 1];
					child.depth = this.depth + 1;
					child.maxDepth = this.maxDepth;
					child.parent = this;
					
					child.itemTemplate = this.itemTemplate;
					child.editTemplate = this.editTemplate;
					child.createTemplate = this.createTemplate;
					child.deleteTemplate = this.deleteTemplate;
					Polymer.dom(Polymer.dom(this.root).querySelector(".children")).appendChild(child);

					contentEl.parentNode.removeChild(contentEl);
					this.initializeTemplate(false);
			},

			setupDelete : function(ev) {
				contentEl = Polymer.dom(this.root).querySelector('[content]');

				if(this.deleteTemplate)
				{
					this.templatize(this.deleteTemplate);

					var clone = this.stamp(this.commands);

					contentEl.innerHTML = "";
					Polymer.dom(contentEl).appendChild(clone.root);

					contentEl.querySelector('[close-button]').addEventListener('click', function() {
						contentEl.parentNode.removeChild(contentEl);
						this.initializeTemplate(false);
					}.bind(this));

					contentEl.querySelector('[simple-delete]').addEventListener('click', this._delete.bind(this));

					contentEl.querySelector('[delete-with-child-nodes]').addEventListener('click', this._delete.bind(this));

					contentEl.querySelector('[recursive-delete]').addEventListener('click', this.recursiveDelete.bind(this));
				}
			},

			recursiveDelete : function(ev) {

				if(this.data['children'] && this.data.children.length > 0)
				{
					var kids = this.querySelector('.children').children;
					while(kids.length)
						kids[0].recursiveDelete();
				}
				this._delete();

			},

			_delete : function() {	
				var itemUrl = "/category/json/" + this.data.id + "/delete/";

				this.fire('delete-ev', itemUrl);
				
				for(var item in this.data)
					delete this.data[item];					

				if(this.parent)
				{
					var parentKids = this.parent.data['children'];

					for(var i = 0; i < parentKids.length; i++)
						if(this.isEmptyObject(parentKids[i]))
							parentKids.splice(i, 1);
				}

				this.parentNode.removeChild(this);
			},

			isEmptyObject : function(obj) {
				for(var field in obj) return false;

				return true;
			},
			
			updateStyles : function() {
				var totalHeight = 0, i = 0;

				if(!this.childrenContainer)
					return;

				if(this.collapsed)
					this.childrenContainer.style.height = 0 + "px";
				else
					this.childrenContainer.style.height = this.childrenContainer._height + "px";
					
				while(i < this.childrenContainer.childNodes.length)
					totalHeight += this.childrenContainer.childNodes[i++].getBoundingClientRect().height;

				this.childrenContainer._height = totalHeight;
				if(!this.collapsed)
					this.childrenContainer.style.height = totalHeight + "px";
				
				this.expanders.forEach(function(el) { el.style.display = this.collapsed ? "inline-block" : "none" }.bind(this));
				this.collapsers.forEach(function(el) { el.style.display = !this.collapsed ? "inline-block" : "none" }.bind(this));
			},

			initializeTemplate : function(withChild) {
				var i = 0, childrenContainer, child;
				if(!this.itemTemplate)
					return;
								
				this.templatize(this.itemTemplate);

				var clone = this.stamp(this.commands), e, c, eb, cb, db;

				console.log(this.data);
				
				clone.data = this.data;
				clone.itemTemplate = this.itemTemplate;
				clone.editTemplate = this.editTemplate;
				clone.createTemplate = this.createTemplate;
				clone.deleteTemplate = this.deleteTemplate;
				
				if(withChild)
					Polymer.dom(this.root).appendChild(clone.root);
				else
					Polymer.dom(this.root).querySelector('.wrapper').insertBefore(clone.root.querySelector('[content]'), Polymer.dom(this.root).querySelector('.wrapper').children[0]);
				
				this.childrenContainer = childrenContainer = Polymer.dom(this.root).querySelector(".children");
				this.expanders = e = Array.prototype.slice.call(Polymer.dom(this.root).querySelectorAll("[expand]"));
				this.collapsers = c = Array.prototype.slice.call(Polymer.dom(this.root).querySelectorAll("[collapse]"));
				this.editButtons = eb = Array.prototype.slice.call(Polymer.dom(this.root).querySelectorAll("[edit-button]"));
				this.createButtons = cb = Array.prototype.slice.call(Polymer.dom(this.root).querySelectorAll("[create-button]"));
				this.deleteButtons = db = Array.prototype.slice.call(Polymer.dom(this.root).querySelectorAll("[delete-button]"));
				e.forEach(function(el) { 
					el.style.display = 'none';
					el.addEventListener('click', this.expand.bind(this));
				}.bind(this));
				c.forEach(function(el) { 
					el.addEventListener('click', this.collapse.bind(this));
				}.bind(this));
				eb.forEach(function(el) {
					el.addEventListener('click', this.edit.bind(this));
				}.bind(this));
				cb.forEach(function(el) {
					el.addEventListener('click', this.create.bind(this));
				}.bind(this));
				db.forEach(function(el) {
					el.addEventListener('click', this.setupDelete.bind(this));
				}.bind(this));

				this.addEventListener('update-styles', this.updateStyles );

				if(withChild) {
					if(this.data.children)
						while(i < this.data.children.length)
						{
							child = document.createElement('ir-recursive-item');
							child.data = this.data.children[i];
							child.depth = this.depth + 1;
							child.maxDepth = this.maxDepth;
							child.parent = this;
							
							child.itemTemplate = this.itemTemplate;
							child.editTemplate = this.editTemplate;
							child.createTemplate = this.createTemplate;
							child.deleteTemplate = this.deleteTemplate;
							Polymer.dom(childrenContainer).appendChild(child);

							i++;
						}
					else
						Polymer.dom(this.root).querySelector("[children-toolbar]").querySelector("[nav-group]").style.display = 'none';
						

				}
				
				this.childrenContainer.style.overflow = 'hidden';

				if(this.maxDepth >= 0 && this.depth > this.maxDepth)
					this.collapse();
				else
					this.expand();
			},

			attached: function() {
				this.initializeTemplate(true);
			}
		});
	})();
</script> 