<link rel="import" href="../iron-ajax/iron-ajax.html">


<dom-module id="ir-recursive">  
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <content id="templates" select="template"></content>
    <iron-ajax
    	id="getDataLoader"
    	method="GET"
    	handle-as="json"
    	url="/category/json/?limit=100"
    	last-response="{{ reqData }}"
    	on-response="transformData"
    	debounce-duration="300"
    ></iron-ajax>
    <iron-ajax
		id="deleteLoader"
		method="DELETE"
		content-type = "application/x-www-form-urlencoded"
		handle-as="json"
		on-response="setAvailable"
		debounce-duration="300"
		verbose=true
	></iron-ajax>
  </template>
</dom-module>
<script>
  (function () {
    Polymer({
		is: 'ir-recursive',
		properties: {
			data: {
				type: Object,
				notify: true
			},
			reqData : {
				type: Object,
				value : {}
			},
			notifyUrl : {
				type : String,
				value : "",
				observer : "_notifyUrlChanged"
			},
			withSelect : {
				type : Boolean,
				value : false,
				notify : true
			},	
			meta : {
				type: Object,
				value : {}
			},			
			tree : {
				type: Object,
				value : {},
				observer : "treeReady"
			},		
			itemTemplate: {
				type: Object,
				notify: true
			},
			initSelector: {
				type: String,
				notify: true
			},
			onInit: {
				type: String,
				notify: true
			},
			maxDepth: {
				type: Number,
				notify: true
			},
			isAvail: {
				type: Boolean,
				value: true
			},
			itemsToDelete: {
				type: Array,
				value: []
			},
			urlEdit: {
				type: String,
				notify: true
			},
			urlGet: {
				type: String,
				notify: true
			},
			urlCreate: {
				type: String,
				notify: true
			},
			urlSubmit: {
				type: String,
				notify: true
			},
			urlAdd: {
				type: String,
				notify: true
			},
			urlDelete: {
				type: String,
				notify: true
			}
		},
		  
		behaviors: [
			Polymer.Templatizer
		],
		
		expand : function(ev) {
			ev.target._height = 0;
			ev.target.style.height = ev.target._height;
		},
		collapse : function(ev) {
			ev._height = 0;
			ev.style.height = 0;
		},

		treeReady : function() {
			if(!this.isTreeEmpty())
				this.drawTemplates();
		},

		isTreeEmpty : function() {
			for(var field in this.tree) 
				return false;

			return true;
		},

		transformData : function() {
			this.tree = this.reqData;
		},

		handleItem : function() {

		},

		setAvailable : function() {
			if(this.itemsToDelete.length > 0)
				this.deleteItem(this.itemsToDelete.shift());
			else
				this.isAvail = true;
		},

		deleteItem : function(itemUrl) {
			this.$.deleteLoader.url = itemUrl;
			this.$.deleteLoader.generateRequest();
		},
		
		_notifyUrlChanged : function() {
			if(!this.notifyUrl)
				return;
				
			this.$.getDataLoader.url = this.notifyUrl;
			this.$.getDataLoader.generateRequest();		
		},
		
		ready: function() {
			this.addEventListener('delete-ev', function(ev) {
				if(this.isAvail)
				{
					this.isAvail = false;
					this.deleteItem(ev.detail);
				}
				else
					this.itemsToDelete.push(ev.detail);		
			}.bind(this));

			var templates = Polymer.dom(this.$.templates).getDistributedNodes(),
				scriptTemplate;
			templates.forEach(function(el) {
				if(el.nodeType == 1 && el.hasAttribute('script-t'))
					scriptTemplate = el;
			});

			if(scriptTemplate)
			{
				this.templatize(scriptTemplate);
				
				var clone = this.stamp(this.commands);
				
				Polymer.dom(this.root).appendChild(clone.root);
				
				this.fire('script-ready');
			}

			//this.templatize(template);
			//this.itemTemplate = template;	
		},

		drawTemplates : function() {
			var ri, templates = Polymer.dom(this.$.templates).getDistributedNodes(),
				scriptTemplate;
			templates.forEach(function(el) {
				if(el.hasAttribute('item'))
					this.itemTemplate = el;
				if(el.hasAttribute('edit'))
					this.editTemplate = el;
				if(el.hasAttribute('create'))
					this.createTemplate = el;
				if(el.hasAttribute('delete'))
					this.deleteTemplate = el;
				if(el.hasAttribute('script-t'))
					scriptTemplate = el;
			}.bind(this));

			ri = document.createElement('ir-recursive-item');

			"itemTemplate,editTemplate,createTemplate,deleteTemplate".split(/,/).forEach(function(tp){
				ri[tp] = this[tp];
			}.bind(this));
			"urlEdit,urlGet,urlCreate,urlSubmit,urlAdd,urlDelete".split(/,/).forEach(function(url){
				ri[url] = this[url];
			}.bind(this));

			if(this.withSelect)
				ri.withSelect = true;
			ri.data = this.tree;
			ri.id = this.tree.id;	
			ri.initSelector = this.initSelector;
			ri.onInit  = this.onInit;
			ri.maxDepth = this.maxDepth;
			ri.depth = 0;
			ri.meta = this.meta;
			
			Polymer.dom(this.root).appendChild(ri);
		}
    });
	
	var behavior = {
	}
  })();
</script> 

<dom-module id="ir-recursive-item">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
  	<iron-ajax
		id="getItemLoader"
		content-type="application/json"
		method="GET"
		handle-as="json"
		on-response="editItem"
		debounce-duration="300"
		verbose=true
	></iron-ajax>
	<iron-ajax
		id="addLoader"
		method="POST"
		content-type="application/json"
		handle-as="json"
		debounce-duration="300"
		verbose=true
	></iron-ajax>
  </template>
</dom-module>

<script>
	(function () {
		Polymer({
			is: 'ir-recursive-item',
			properties: {
				data: {
					type: Object,
					notify: true
				},
				meta: {
					type : Object,
					notify: true
				},
				lastItem: {
					type: Object,
					value: {}
				},
				urlEdit: {
					type: String,
					notify: true
				},
				urlGet: {
					type: String,
					notify: true
				},
				urlCreate: {
					type: String,
					notify: true
				},
				urlSubmit: {
					type: String,
					notify: true
				},
				urlAdd: {
					type: String,
					notify: true
				},
				urlDelete: {
					type: String,
					notify: true
				},
				itemTemplate: {
					type : Object,
					notify: true
				},
				editTemplate: {
					type : Object,
					notify: true
				},
				createTemplate: {
					type : Object,
					notify: true
				},
				initSelector: {
					type: String,
					notify: true
				},
				onInit: {
					type: String,
					notify: true
				},
				maxDepth: {
					type: Number,
					notify: true
				},
				depth: {
					type: Number,
					notify: true,
					value: 0
				}
			},
			behaviors: [
				Polymer.Templatizer
			],

			expand : function(ev) {
				this.collapsed = false;
				this._updateStyles();

				for(i = 0; i <= 400; i += 100)
					setTimeout(function() {
						this.fire('update-styles');
					}.bind(this), i);
			},
			
			collapse : function(ev) {
				this.collapsed = true;
				this.childrenContainer.style.transition = "all 300ms";
				this.childrenContainer._height = this.childrenContainer.getBoundingClientRect().height || this.childrenContainer._height;
				this._updateStyles();
				for(i = 0; i <= 400; i += 100)
					setTimeout(function() {
						this.fire('update-styles');
					}.bind(this), i);
			},

			edit : function(ev) {
				contentEl = Polymer.dom(this.root).querySelector('[content]');

				if(this.editTemplate)
				{
					this.templatize(this.editTemplate);

					var clone = this.stamp(this.commands);

					contentEl.innerHTML = "";
					Polymer.dom(contentEl).appendChild(clone.root);

					var iframe = document.createElement('shadow-iframe');
						iframe.urlParams ='{ "noCache" : "true" }';
						iframe.hijackForm = true;
						iframe.url = this.urlEdit.replace('[id]', this.data.id);
						var that = this;
						iframe.formSubmitted = function(ev) {
							this.isSubmitInProgress = false;
							this.httpMethod = null;

							var item;

							that.$.getItemLoader.url = that.urlGet.replace('[id]', that.data.id);
							that.$.getItemLoader.generateRequest();
							
								
							this.setDisplayMode('ready');

							this._form = null;
						};

					Polymer.dom(contentEl).appendChild(iframe);
					this._updateStyles();

					for(i = 0; i <= 400; i += 100)
						setTimeout(function() {
							this.fire('update-styles');
						}.bind(this), i);

					var closebutton, savebutton;

					if(closebutton = contentEl.querySelector('[close-button]'))
						closebutton.addEventListener('click', function() {

							contentEl.parentNode.removeChild(contentEl);
							this.initializeTemplate(false);

						}.bind(this));

					if(savebutton = contentEl.querySelector('[save-button]'))
						savebutton.addEventListener('click', function(ev) {
							this.data.title = this.querySelector('[edit-input]').value;

							contentEl.parentNode.removeChild(contentEl);
							this.initializeTemplate(false);
						}.bind(this));

				}
				
			},

			editItem : function() {
				var contentEl = Polymer.dom(this.root).querySelector('[content]');

				var item = this.$.getItemLoader.lastResponse;

				this.data.id = item.id;
				this.data.title = item.title;
				this.data.content = item.content;

				contentEl.parentNode.removeChild(contentEl);
				this.initializeTemplate(false);
			},

			create : function(ev) {
				contentEl = Polymer.dom(this.root).querySelector('[content]');
				
				if(this.createTemplate)
				{
					this.templatize(this.createTemplate);

					var clone = this.stamp(this.commands);

					contentEl.innerHTML = "";
					Polymer.dom(contentEl).appendChild(clone.root);
					
					var iframe = document.createElement('shadow-iframe');
						iframe.urlParams ='{ "noCache" : "true" }';
						iframe.hijackForm = true;
						iframe.url = this.urlCreate;
						iframe.submitUrl = this.urlSubmit;
						var that = this;
						iframe.formSubmitted = function(ev) {
							this.isSubmitInProgress = false;
							this.httpMethod = null;
							that.createItem(this.lastFormResponse);
							this.setDisplayMode('ready');

							this._form = null;
						};
					
					Polymer.dom(contentEl).appendChild(iframe);
					this._updateStyles();
					for(i = 0; i <= 400; i += 100)
						setTimeout(function() {
							this.fire('update-styles');
						}.bind(this), i);

					var closebutton;

					if(closebutton = contentEl.querySelector('[close-button]'))
						closebutton.addEventListener('click', function() {
							contentEl.parentNode.removeChild(contentEl);
							this.initializeTemplate(false);
						}.bind(this));
				}
			},

			createItem : function(item) {
				var newData = {};
				var contentEl = Polymer.dom(this.root).querySelector('[content]');

				item = JSON.parse(item);

				if(this.data.id != 0)
				{
					this.$.addLoader.url = this.urlAdd.replace('[id]', this.data.id);
					this.$.addLoader.body = JSON.stringify({ 'id' : item.id });
					this.$.addLoader.generateRequest();
				}
				

				newData['id'] = item.id;
				newData['title'] = item.title;
				newData['content'] = item.content; 

				if(!this.data['children'])
					this.data['children'] = [];

				this.data['children'].push(newData);

				var child = document.createElement('ir-recursive-item');
					child.data = this.data.children[this.data.children.length - 1];
					child.depth = this.depth + 1;
					child.maxDepth = this.maxDepth;
					child.parent = this;

					"itemTemplate,editTemplate,createTemplate,deleteTemplate".split(/,/).forEach(function(tp){
						child[tp] = this[tp];
					}.bind(this));
					"urlEdit,urlGet,urlCreate,urlSubmit,urlAdd,urlDelete".split(/,/).forEach(function(url){
						child[url] = this[url];
					}.bind(this));

					Polymer.dom(Polymer.dom(this.root).querySelector(".children")).appendChild(child);

					contentEl.parentNode.removeChild(contentEl);
					this.initializeTemplate(false);
			},

			setupDelete : function(ev) {
				contentEl = Polymer.dom(this.root).querySelector('[content]');

				if(this.deleteTemplate)
				{
					this.templatize(this.deleteTemplate);

					var clone = this.stamp(this.commands);

					contentEl.innerHTML = "";
					Polymer.dom(contentEl).appendChild(clone.root);
					this._updateStyles();
					for(i = 0; i <= 400; i += 100)
						setTimeout(function() {
							this.fire('update-styles');
						}.bind(this), i);

					var closebutton, simple, withChild, recursiveDel;

					if(closebutton = contentEl.querySelector('[close-button]'))
						closebutton.addEventListener('click', function() {
							contentEl.parentNode.removeChild(contentEl);
							this.initializeTemplate(false);
						}.bind(this));

					if(simple = contentEl.querySelector('[simple-delete]'))
						simple.addEventListener('click', this._delete.bind(this));

					if(withChild = contentEl.querySelector('[delete-with-child-nodes]'))
						withChild.addEventListener('click', this._delete.bind(this));

					if(recursiveDel = contentEl.querySelector('[recursive-delete]'))
						recursiveDel.addEventListener('click', this.recursiveDelete.bind(this));
				}
			},

			recursiveDelete : function(ev) {

				if(this.data['children'] && this.data.children.length > 0)
				{
					var kids = this.querySelector('.children').children;
					while(kids.length)
						kids[0].recursiveDelete();
				}
				this._delete();

			},

			_delete : function() {	
				var itemUrl = this.urlDelete.replace('[id]', this.data.id);

				this.fire('delete-ev', itemUrl);
				
				for(var item in this.data)
					delete this.data[item];					

				if(this.parent)
				{
					var parentKids = this.parent.data['children'];

					for(var i = 0; i < parentKids.length; i++)
						if(this.isEmptyObject(parentKids[i]))
							parentKids.splice(i, 1);
				}

				this.parentNode.removeChild(this);
			},

			isEmptyObject : function(obj) {
				for(var field in obj) return false;

				return true;
			},
			
			_updateStyles : function() {
				var totalHeight = 0, i = 0;

				if(!this.childrenContainer)
					return;

				if(this.collapsed)
					this.childrenContainer.style.height = 0 + "px";
				else
					this.childrenContainer.style.height = this.childrenContainer._height + "px";
					
				for(i = 0; i < this.childrenContainer.childNodes.length; i++)
					if(this.childrenContainer.childNodes[i].getBoundingClientRect)
						totalHeight += this.childrenContainer.childNodes[i].getBoundingClientRect().height;
						
						
				this.childrenContainer._height = totalHeight;
				if(!this.collapsed)
					this.childrenContainer.style.height = totalHeight + "px";
				
				this.expanders.forEach(function(el) { el.style.display = this.collapsed ? "inline-block" : "none" }.bind(this));
				this.collapsers.forEach(function(el) { el.style.display = !this.collapsed ? "inline-block" : "none" }.bind(this));
				
				this.updateStyles();
			},

			initializeTemplate : function(withChild) {
				var i = 0, childrenContainer, child;

				
				if(!this.itemTemplate)
					return;
								
				this.templatize(this.itemTemplate);

				var clone = this.stamp(this.commands), e, c, eb, cb, db;

				clone.data = this.data;					
				clone.itemTemplate = this.itemTemplate;
				clone.editTemplate = this.editTemplate;
				clone.createTemplate = this.createTemplate;
				clone.deleteTemplate = this.deleteTemplate;
				clone.meta = this.meta;
				
				if(withChild)
					Polymer.dom(this.root).appendChild(clone.root);
				else
					Polymer.dom(this.root).querySelector('.wrapper').insertBefore(clone.root.querySelector('[content]'), Polymer.dom(this.root).querySelector('.wrapper').children[0]);
				
				this.childrenContainer = childrenContainer = Polymer.dom(this.root).querySelector(".children");
				this.expanders = e = Array.prototype.slice.call(Polymer.dom(this.root).querySelectorAll("[expand]"));
				this.collapsers = c = Array.prototype.slice.call(Polymer.dom(this.root).querySelectorAll("[collapse]"));
				this.editButtons = eb = Array.prototype.slice.call(Polymer.dom(this.root).querySelectorAll("[edit-button]"));
				this.createButtons = cb = Array.prototype.slice.call(Polymer.dom(this.root).querySelectorAll("[create-button]"));
				this.deleteButtons = db = Array.prototype.slice.call(Polymer.dom(this.root).querySelectorAll("[delete-button]"));
				e.forEach(function(el) { 
					el.style.display = 'none';
					el.addEventListener('click', this.expand.bind(this));
				}.bind(this));
				c.forEach(function(el) { 
					el.addEventListener('click', this.collapse.bind(this));
				}.bind(this));
				eb.forEach(function(el) {
					el.addEventListener('click', this.edit.bind(this));
				}.bind(this));
				cb.forEach(function(el) {
					el.addEventListener('click', this.create.bind(this));
				}.bind(this));
				db.forEach(function(el) {
					el.addEventListener('click', this.setupDelete.bind(this));
				}.bind(this));

				this.addEventListener('update-styles', this._updateStyles );

				if(withChild) {
					if(this.data.children)
					{
						if(this.data.children.length == 0)
							Polymer.dom(this.root).querySelector("[children-toolbar]").querySelector("[nav-group]").style.display = 'none';

						while(i < this.data.children.length)
						{
							child = document.createElement('ir-recursive-item');
							child.data = this.data.children[i];
							child.id = this.data.children[i].id;
							child.depth = this.depth + 1;
							child.maxDepth = this.maxDepth;
							child.parent = this;
							child.meta = this.meta;

							"itemTemplate,editTemplate,createTemplate,deleteTemplate".split(/,/).forEach(function(tp){
								child[tp] = this[tp];
							}.bind(this));
							"urlEdit,urlGet,urlCreate,urlSubmit,urlAdd,urlDelete".split(/,/).forEach(function(url){
								child[url] = this[url];
							}.bind(this));

							Polymer.dom(childrenContainer).appendChild(child);

							i++;
						}
					}
					else
						Polymer.dom(this.root).querySelector("[children-toolbar]").querySelector("[nav-group]").style.display = 'none';
						

				}
				
				this.childrenContainer.style.overflow = 'hidden';

				if(this.maxDepth >= 0 && this.depth > this.maxDepth)
					this.collapse();
				else
					this.expand();
			},

			attached: function() {
				this.fire('beforeStamp', this);
				this.initializeTemplate(true);
				this.fire('afterStamp', this);
			}
		});
	})();
</script> 